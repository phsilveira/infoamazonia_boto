{% extends "admin/base.html" %}

{% block title %}Semantic Search{% endblock %}

{% block content %}
<div class="container">
    <h1>Semantic Search</h1>
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5>Advanced Semantic Search</h5>
                    <a href="/admin/articles" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Back to Articles
                    </a>
                </div>
                <div class="card-body">
                    <!-- Article Stats -->
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header">Article Statistics</div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-4 text-center">
                                            <h5>Total Articles</h5>
                                            <h3 id="total-articles-count">{{ total_articles }}</h3>
                                        </div>
                                        <div class="col-md-4 text-center">
                                            <h5>Oldest Article</h5>
                                            <h3 id="oldest-article-date">{{ oldest_date or 'N/A' }}</h3>
                                        </div>
                                        <div class="col-md-4 text-center">
                                            <h5>Newest Article</h5>
                                            <h3 id="newest-article-date">{{ newest_date or 'N/A' }}</h3>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Search Introduction -->
                    <div class="alert alert-info mb-4">
                        <h5><i class="bi bi-info-circle"></i> About Semantic Search</h5>
                        <p>This search engine uses advanced techniques to find articles based on meaning and concepts, not just simple keyword matching. Try searching for topics like "climate change effects" or "amazon river pollution" to see related articles.</p>
                    </div>

                    <!-- Search Form -->
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header">Search by Term</div>
                                <div class="card-body">
                                    <form id="search-term-form">
                                        <div class="mb-3">
                                            <label for="query" class="form-label">Search Term</label>
                                            <input type="text" class="form-control" id="query" name="query" placeholder="Enter search term or concept...">
                                        </div>
                                        <div class="mb-3 form-check">
                                            <input type="checkbox" class="form-check-input" id="generate_summary" name="generate_summary">
                                            <label class="form-check-label" for="generate_summary">Generate AI Summary of Results</label>
                                        </div>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="bi bi-search"></i> Search
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Results Section -->
                    <div id="search-results" class="row" style="display: none;">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header">Search Results</div>
                                <div class="card-body">
                                    <div id="results-container">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Fetch article stats when the page loads
    document.addEventListener('DOMContentLoaded', function() {
        // Set up search form submission
        const searchForm = document.getElementById('search-term-form');
        if (searchForm) {
            searchForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const query = document.getElementById('query').value;
                const generateSummary = document.getElementById('generate_summary').checked;
                
                if (!query) {
                    alert('Please enter a search term');
                    return;
                }
                
                // Show loading indicator
                document.getElementById('results-container').innerHTML = '<div class="d-flex justify-content-center"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>';
                document.getElementById('search-results').style.display = 'block';
                
                // Make API request
                fetch('/api/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: query,
                        generate_summary: generateSummary
                    }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayResults(data);
                    } else {
                        document.getElementById('results-container').innerHTML = `<div class="alert alert-danger">${data.error || 'No results found'}</div>`;
                    }
                })
                .catch(error => {
                    console.error('Error performing search:', error);
                    document.getElementById('results-container').innerHTML = `<div class="alert alert-danger">Error performing search: ${error}</div>`;
                });
            });
        }
        
        function displayResults(data) {
            const resultsContainer = document.getElementById('results-container');
            let html = '';
            
            // Show result count
            html += `<div class="alert alert-success mb-4">Found ${data.count} article(s) matching your query.</div>`;
            
            // Show AI summary if available
            if (data.summary) {
                html += `<div class="card mb-4">
                    <div class="card-header">AI Summary of Results</div>
                    <div class="card-body">${data.summary.replace(/\n/g, '<br>')}</div>
                </div>`;
            }
            
            // Show results
            if (data.results && data.results.length > 0) {
                html += '<h4>Articles</h4>';
                html += '<div class="list-group">';
                data.results.forEach(article => {
                    // Format keywords if available
                    let keywordsHtml = '';
                    if (article.key_words && article.key_words.length > 0) {
                        keywordsHtml = '<div class="mt-2">';
                        article.key_words.forEach(keyword => {
                            keywordsHtml += `<span class="badge bg-secondary me-1">${keyword}</span>`;
                        });
                        keywordsHtml += '</div>';
                    }
                    
                    html += `
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h5 class="mb-1">${article.title}</h5>
                                <span class="badge bg-success">Relevance: ${(article.similarity * 100).toFixed(1)}%</span>
                            </div>
                            <p class="mb-1">${article.description || 'No description available.'}</p>
                            ${keywordsHtml}
                            <div class="d-flex justify-content-between align-items-center mt-2">
                                <small class="text-muted">${article.published_date || 'No date'} ${article.author && article.author !== 'Unknown' ? 'by ' + article.author : ''}</small>
                                <div>
                                    <a href="${article.short_url}" class="btn btn-sm btn-outline-primary me-2">View Details</a>
                                    <a href="${article.url}" target="_blank" class="btn btn-sm btn-primary">Read Article</a>
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            } else {
                html += '<div class="alert alert-info">No articles found matching your search term.</div>';
            }
            
            resultsContainer.innerHTML = html;
        }
    });
</script>
{% endblock %}