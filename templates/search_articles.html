{% extends "admin/base.html" %}

{% block title %}Search Term{% endblock %}

{% block content %}
<div class="container">
    <h1>Search Term</h1>
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5>Advanced Search</h5>
                </div>
                <div class="card-body">
                    <!-- Article Stats -->
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header">Article Statistics</div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-4 text-center">
                                            <h5>Total Articles</h5>
                                            <h3 id="total-articles-count">Loading...</h3>
                                        </div>
                                        <div class="col-md-4 text-center">
                                            <h5>Oldest Article</h5>
                                            <h3 id="oldest-article-date">Loading...</h3>
                                        </div>
                                        <div class="col-md-4 text-center">
                                            <h5>Newest Article</h5>
                                            <h3 id="newest-article-date">Loading...</h3>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Search Types Tabs -->
                    <ul class="nav nav-tabs mb-3" id="searchTypeTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="search-articles-tab" data-bs-toggle="tab" data-bs-target="#search-articles" type="button" role="tab" aria-controls="search-articles" aria-selected="false">Search Articles</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="search-term-tab" data-bs-toggle="tab" data-bs-target="#search-term" type="button" role="tab" aria-controls="search-term" aria-selected="true">Search Term</button>
                        </li>
                    </ul>

                    <!-- Search Form -->
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-body">
                                    <form id="search-term-form">
                                        <div class="mb-3">
                                            <label for="query" class="form-label">Search Term</label>
                                            <input type="text" class="form-control" id="query" name="query" placeholder="Enter search term...">
                                        </div>
                                        <div class="mb-3 form-check">
                                            <input type="checkbox" class="form-check-input" id="generate_summary" name="generate_summary">
                                            <label class="form-check-label" for="generate_summary">Generate Summary</label>
                                        </div>
                                        <button type="submit" class="btn btn-primary">Search</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Results Section -->
                    <div id="search-results" class="row" style="display: none;">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header">Search Results</div>
                                <div class="card-body">
                                    <div id="results-container">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Fetch article stats when the page loads
    document.addEventListener('DOMContentLoaded', function() {
        fetch('/api/article-stats')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('total-articles-count').textContent = data.stats.total_count;
                    document.getElementById('oldest-article-date').textContent = data.stats.oldest_date || 'N/A';
                    document.getElementById('newest-article-date').textContent = data.stats.newest_date || 'N/A';
                } else {
                    console.error('Error fetching article stats:', data.error);
                }
            })
            .catch(error => {
                console.error('Error fetching article stats:', error);
            });
            
        // Set up tab functionality for search types
        const searchArticlesTab = document.getElementById('search-articles-tab');
        const searchTermTab = document.getElementById('search-term-tab');
        
        if (searchArticlesTab && searchTermTab) {
            searchArticlesTab.addEventListener('click', function(e) {
                e.preventDefault();
                window.location.href = '/admin/articles';
            });
        }
        
        // Set up search form submission
        const searchForm = document.getElementById('search-term-form');
        if (searchForm) {
            searchForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const query = document.getElementById('query').value;
                const generateSummary = document.getElementById('generate_summary').checked;
                
                if (!query) {
                    alert('Please enter a search term');
                    return;
                }
                
                // Show loading indicator
                document.getElementById('results-container').innerHTML = '<div class="d-flex justify-content-center"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>';
                document.getElementById('search-results').style.display = 'block';
                
                // Make API request
                fetch('/api/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: query,
                        generate_summary: generateSummary
                    }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayResults(data);
                    } else {
                        document.getElementById('results-container').innerHTML = `<div class="alert alert-danger">${data.error || 'No results found'}</div>`;
                    }
                })
                .catch(error => {
                    console.error('Error performing search:', error);
                    document.getElementById('results-container').innerHTML = `<div class="alert alert-danger">Error performing search: ${error}</div>`;
                });
            });
        }
        
        function displayResults(data) {
            const resultsContainer = document.getElementById('results-container');
            let html = '';
            
            if (data.summary) {
                html += `<div class="card mb-4">
                    <div class="card-header">Summary</div>
                    <div class="card-body">${data.summary.replace(/\n/g, '<br>')}</div>
                </div>`;
            }
            
            if (data.results && data.results.length > 0) {
                html += '<h4>Articles</h4>';
                html += '<div class="list-group">';
                data.results.forEach(article => {
                    html += `
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h5 class="mb-1">${article.title}</h5>
                                <small>Similarity: ${(article.similarity * 100).toFixed(1)}%</small>
                            </div>
                            <p class="mb-1">${article.description || 'No description available.'}</p>
                            <div class="d-flex justify-content-between align-items-center">
                                <small>${article.published_date || 'No date'}</small>
                                <a href="${article.url}" target="_blank" class="btn btn-sm btn-primary">Read Article</a>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            } else {
                html += '<div class="alert alert-info">No articles found matching your search term.</div>';
            }
            
            resultsContainer.innerHTML = html;
        }
    });
</script>
{% endblock %}