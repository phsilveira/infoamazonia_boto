{% extends "admin/base.html" %}

{% block title %}User Interactions - InfoAmazonia Admin{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="bg-white shadow rounded-lg p-6">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="text-2xl font-bold m-0">User Interactions</h2>
            <a href="/admin/interactions/export-csv?category=all" class="btn btn-primary">
                <i class="bi bi-file-earmark-spreadsheet"></i> Export All Interactions
            </a>
        </div>

        <!-- Search and Filter Controls -->
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0">Filter Interactions</h5>
            </div>
            <div class="card-body">
                <form action="/admin/interactions" method="get" class="row g-3">
                    <!-- Search -->
                    <div class="col-md-4">
                        <label for="search" class="form-label">Search Query/Response</label>
                        <input type="text" class="form-control" id="search" name="search" value="{{ search or '' }}" 
                               placeholder="Search in queries and responses">
                    </div>
                    
                    <!-- Feedback Filter -->
                    <div class="col-md-4">
                        <label for="feedback" class="form-label">Feedback</label>
                        <select class="form-select" id="feedback" name="feedback">
                            <option value="">All Feedback</option>
                            {% for feedback_option in feedback_options %}
                            <option value="{{ feedback_option }}" {% if feedback == feedback_option %}selected{% endif %}>
                                {% if feedback_option == 'positive' %}üëç Positive
                                {% elif feedback_option == 'negative' %}üëé Negative
                                {% else %}‚ùì No Feedback
                                {% endif %}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Phone Number Filter -->
                    <div class="col-md-4">
                        <label for="phone_number" class="form-label">Phone Number</label>
                        <select class="form-select" id="phone_number" name="phone_number">
                            <option value="">All Phone Numbers</option>
                            {% for number in phone_numbers %}
                            <option value="{{ number }}" {% if phone_number == number %}selected{% endif %}>
                                {{ number }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Filter Button -->
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-funnel"></i> Apply Filters
                        </button>
                        <a href="/admin/interactions" class="btn btn-outline-secondary">
                            <i class="bi bi-x-circle"></i> Clear Filters
                        </a>
                    </div>
                </form>
            </div>
        </div>

        <!-- Nav tabs -->
        <ul class="nav nav-tabs mb-4" id="interactionTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="term-tab" data-bs-toggle="tab" data-bs-target="#term" type="button" role="tab">
                    Term Explanations
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="article-tab" data-bs-toggle="tab" data-bs-target="#article" type="button" role="tab">
                    Article Summaries
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="news-tab" data-bs-toggle="tab" data-bs-target="#news" type="button" role="tab">
                    News Suggestions
                </button>
            </li>
        </ul>

        <!-- Tab content -->
        <div class="tab-content" id="interactionTabContent">
            {% for category in ['term', 'article', 'news_suggestion'] %}
            <div class="tab-pane fade {% if category == 'term' %}show active{% endif %}" 
                 id="{{ category.split('_')[0] }}" role="tabpanel">

                <!-- Export Button and Summary Section -->
                <div class="mb-4 p-4 bg-gray-50 rounded">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h3 class="text-lg font-semibold m-0">Query Summary</h3>
                        <a href="/admin/interactions/export-csv?category={{ category }}" class="btn btn-sm btn-primary">
                            <i class="bi bi-file-earmark-spreadsheet"></i> Export {{ category | replace('_', ' ') | title }} to CSV
                        </a>
                    </div>
                    <div id="{{ category }}-summary" class="text-gray-700">
                        Loading summary...
                    </div>
                    <div id="{{ category }}-system-prompt" class="mt-3 border-top pt-3 text-gray-600" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h5 class="text-sm font-semibold mb-0">System Prompt:</h5>
                            {% if category == 'term' %}
                            <button type="button" class="btn btn-sm btn-success" onclick="runCustomPrompt('{{ category }}')">
                                <i class="bi bi-play-fill"></i> Run Custom Prompt
                            </button>
                            {% endif %}
                        </div>
                        {% if category == 'term' %}
                        <textarea id="{{ category }}-prompt-editor" class="form-control mb-3" rows="6" style="font-size: 0.85rem; font-family: monospace;" 
                                  placeholder="Edit the system prompt here..."></textarea>
                        {% endif %}
                        <pre class="bg-light p-3 rounded" style="font-size: 0.85rem;"></pre>
                        <div class="text-muted mt-2 text-sm">Based on the last <span class="query-count"></span> queries</div>
                    </div>
                </div>

                <!-- Interactions Table -->
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Query</th>
                                <th>Response</th>
                                <th>Feedback</th>
                                <th>Created At</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for interaction in interactions %}
                                {% if interaction.category == category %}
                                <tr>
                                    <td>
                                        {% if interaction.user %}
                                        <a href="/admin/users/{{ interaction.user.id }}" class="text-blue-500 hover:text-blue-700">
                                            {{ interaction.user.name or interaction.user.phone_number }}
                                        </a>
                                        {% else %}
                                        {{ interaction.phone_number }}
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="text-truncate d-inline-block" style="max-width: 200px;">
                                            {{ interaction.query }}
                                        </span>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#responseModal{{ interaction.id }}">
                                            View Response
                                        </button>
                                    </td>
                                    <td>
                                        {% if interaction.feedback == True %}
                                        <span class="badge bg-success">üëç Helpful</span>
                                        {% elif interaction.feedback == False %}
                                        <span class="badge bg-danger">üëé Not Helpful</span>
                                        {% else %}
                                        <span class="badge bg-secondary">No Feedback</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ interaction.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                                </tr>

                                <!-- Response Modal -->
                                <div class="modal fade" id="responseModal{{ interaction.id }}" tabindex="-1">
                                    <div class="modal-dialog modal-lg">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title">Response Details</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                            </div>
                                            <div class="modal-body">
                                                <p class="text-muted mb-2">Query:</p>
                                                <p class="mb-4">{{ interaction.query }}</p>
                                                <p class="text-muted mb-2">Response:</p>
                                                <p style="white-space: pre-wrap;">{{ interaction.response }}</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                {% if total_pages > 1 %}
                <div class="d-flex justify-content-between align-items-center mt-4">
                    <div>
                        Showing {{ interactions|length }} of {{ total_interactions }} interactions
                    </div>
                    <ul class="pagination">
                        {% if page > 1 %}
                        <li class="page-item">
                            <a class="page-link" href="/admin/interactions?{% if search %}search={{ search }}&{% endif %}{% if feedback %}feedback={{ feedback }}&{% endif %}{% if phone_number %}phone_number={{ phone_number }}&{% endif %}page={{ page - 1 }}">
                                <i class="bi bi-chevron-left"></i> Previous
                            </a>
                        </li>
                        {% endif %}
                        
                        {% for p in range(1, total_pages + 1) %}
                        {% if p >= page - 2 and p <= page + 2 %}
                        <li class="page-item {{ 'active' if p == page else '' }}">
                            <a class="page-link" href="/admin/interactions?{% if search %}search={{ search }}&{% endif %}{% if feedback %}feedback={{ feedback }}&{% endif %}{% if phone_number %}phone_number={{ phone_number }}&{% endif %}page={{ p }}">
                                {{ p }}
                            </a>
                        </li>
                        {% endif %}
                        {% endfor %}
                        
                        {% if page < total_pages %}
                        <li class="page-item">
                            <a class="page-link" href="/admin/interactions?{% if search %}search={{ search }}&{% endif %}{% if feedback %}feedback={{ feedback }}&{% endif %}{% if phone_number %}phone_number={{ phone_number }}&{% endif %}page={{ page + 1 }}">
                                Next <i class="bi bi-chevron-right"></i>
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Initialize Bootstrap tabs
    document.addEventListener('DOMContentLoaded', function() {
        var triggerTabList = [].slice.call(document.querySelectorAll('#interactionTabs button'))
        triggerTabList.forEach(function(triggerEl) {
            var tabTrigger = new bootstrap.Tab(triggerEl)
            triggerEl.addEventListener('click', function(event) {
                event.preventDefault()
                tabTrigger.show()
                // Get full category name, handling 'news_suggestion' special case
                let category = this.getAttribute('data-bs-target').replace('#', '')
                if (category === 'news') {
                    category = 'news_suggestion'
                }
                loadSummary(category)
            })
        })

        // Load initial summary for the active tab
        loadSummary('term')
    });

    async function loadSummary(category) {
        const summaryElement = document.getElementById(`${category}-summary`)
        const systemPromptElement = document.getElementById(`${category}-system-prompt`)
        
        try {
            const response = await fetch(`/admin/interactions/summaries/${category}`)
            if (!response.ok) throw new Error('Network response was not ok')
            const data = await response.json()
            
            // Update the summary content
            summaryElement.innerHTML = `<div class="whitespace-pre-wrap">${data.summary}</div>`
            
            // For term and news_suggestion categories, show system prompt
            if (category === 'term' || category === 'news_suggestion') {
                if (data.system_prompt) {
                    systemPromptElement.style.display = 'block'
                    systemPromptElement.querySelector('pre').textContent = data.system_prompt
                    systemPromptElement.querySelector('.query-count').textContent = data.query_count || '50'
                    
                    // For term category, populate the editable textarea
                    if (category === 'term') {
                        const promptEditor = document.getElementById(`${category}-prompt-editor`)
                        if (promptEditor && !promptEditor.value) {
                            promptEditor.value = data.system_prompt
                        }
                    }
                } else {
                    systemPromptElement.style.display = 'none'
                }
            } else {
                systemPromptElement.style.display = 'none'
            }
        } catch (error) {
            console.error('Error loading summary:', error)
            summaryElement.innerHTML = 'Failed to load summary. Please try again later.'
            systemPromptElement.style.display = 'none'
        }
    }

    async function runCustomPrompt(category) {
        const promptEditor = document.getElementById(`${category}-prompt-editor`)
        const summaryElement = document.getElementById(`${category}-summary`)
        const button = event.target
        
        if (!promptEditor || !promptEditor.value.trim()) {
            alert('Please enter a custom prompt to run.')
            return
        }
        
        // Show loading state
        const originalText = button.innerHTML
        button.innerHTML = '<i class="bi bi-hourglass-split"></i> Running...'
        button.disabled = true
        summaryElement.innerHTML = '<div class="text-muted">Generating summary with custom prompt...</div>'
        
        try {
            const response = await fetch(`/admin/interactions/summaries/${category}/custom`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    custom_prompt: promptEditor.value.trim()
                })
            })
            
            if (!response.ok) throw new Error('Network response was not ok')
            const data = await response.json()
            
            // Update the summary with the new result
            summaryElement.innerHTML = `<div class="whitespace-pre-wrap">${data.summary}</div>`
            
            // Update the displayed system prompt
            const systemPromptElement = document.getElementById(`${category}-system-prompt`)
            if (systemPromptElement) {
                systemPromptElement.querySelector('pre').textContent = data.system_prompt || promptEditor.value
            }
            
        } catch (error) {
            console.error('Error running custom prompt:', error)
            summaryElement.innerHTML = '<div class="text-danger">Failed to generate summary with custom prompt. Please try again.</div>'
        } finally {
            // Restore button state
            button.innerHTML = originalText
            button.disabled = false
        }
    }
</script>
{% endblock %}