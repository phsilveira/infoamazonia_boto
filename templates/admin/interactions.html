{% extends "admin/base.html" %}

{% block title %}User Interactions - InfoAmazonia Admin{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="bg-white shadow rounded-lg p-6">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="text-2xl font-bold m-0">User Interactions</h2>
            <a href="/admin/interactions/export-csv?category=all" class="btn btn-primary">
                <i class="bi bi-file-earmark-spreadsheet"></i> Export All Interactions
            </a>
        </div>

        <!-- Search and Filter Controls -->
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0">Filter Interactions</h5>
            </div>
            <div class="card-body">
                <form id="filterForm" class="row g-3">
                    <!-- Search -->
                    <div class="col-md-6">
                        <label for="search" class="form-label">Search Query/Response</label>
                        <input type="text" class="form-control" id="search" name="search" value="{{ search or '' }}" 
                               placeholder="Search in queries and responses">
                    </div>
                    
                    <!-- Feedback Filter -->
                    <div class="col-md-6">
                        <label for="feedback" class="form-label">Feedback</label>
                        <select class="form-select" id="feedback" name="feedback">
                            <option value="">All Feedback</option>
                            {% for feedback_option in feedback_options %}
                            <option value="{{ feedback_option }}" {% if feedback == feedback_option %}selected{% endif %}>
                                {% if feedback_option == 'positive' %}üëç Positive
                                {% elif feedback_option == 'negative' %}üëé Negative
                                {% else %}‚ùì No Feedback
                                {% endif %}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Filter Button -->
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-funnel"></i> Apply Filters
                        </button>
                        <button type="button" class="btn btn-outline-secondary ms-2" onclick="clearFilters()">
                            <i class="bi bi-x-circle"></i> Clear Filters
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Nav tabs -->
        <ul class="nav nav-tabs mb-4" id="interactionTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="term-tab" data-bs-toggle="tab" data-bs-target="#term" type="button" role="tab">
                    Term Explanations
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="article-tab" data-bs-toggle="tab" data-bs-target="#article" type="button" role="tab">
                    Article Summaries
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="news-tab" data-bs-toggle="tab" data-bs-target="#news" type="button" role="tab">
                    News Suggestions
                </button>
            </li>
        </ul>

        <!-- Tab content -->
        <div class="tab-content" id="interactionTabContent">
            {% for category in ['term', 'article', 'news_suggestion'] %}
            <div class="tab-pane fade {% if category == current_category %}show active{% endif %}" 
                 id="{{ category.split('_')[0] }}" role="tabpanel">

                <!-- Export Button and Summary Section -->
                <div class="mb-4 p-4 bg-gray-50 rounded">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h3 class="text-lg font-semibold m-0">Query Summary</h3>
                        <a href="/admin/interactions/export-csv?category={{ category }}" class="btn btn-sm btn-primary">
                            <i class="bi bi-file-earmark-spreadsheet"></i> Export {{ category | replace('_', ' ') | title }} to CSV
                        </a>
                    </div>
                    <div id="{{ category }}-summary" class="text-gray-700">
                        Loading summary...
                    </div>
                </div>

                <!-- Interactions Table -->
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Query</th>
                                <th>Response</th>
                                <th>Feedback</th>
                                <th>Created At</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for interaction in categories_data[category]['interactions'] %}
                                <tr>
                                    <td>
                                        {% if interaction.user %}
                                        <a href="/admin/users/{{ interaction.user.id }}" class="text-blue-500 hover:text-blue-700">
                                            {{ interaction.user.name or interaction.user.phone_number }}
                                        </a>
                                        {% else %}
                                        {{ interaction.phone_number }}
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="text-truncate d-inline-block" style="max-width: 200px;">
                                            {{ interaction.query }}
                                        </span>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#responseModal{{ interaction.id }}">
                                            View Response
                                        </button>
                                    </td>
                                    <td>
                                        {% if interaction.feedback == True %}
                                        <span class="badge bg-success">üëç Helpful</span>
                                        {% elif interaction.feedback == False %}
                                        <span class="badge bg-danger">üëé Not Helpful</span>
                                        {% else %}
                                        <span class="badge bg-secondary">No Feedback</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ interaction.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                                </tr>

                                <!-- Response Modal -->
                                <div class="modal fade" id="responseModal{{ interaction.id }}" tabindex="-1">
                                    <div class="modal-dialog modal-lg">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title">Response Details</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                            </div>
                                            <div class="modal-body">
                                                <p class="text-muted mb-2">Query:</p>
                                                <p class="mb-4">{{ interaction.query }}</p>
                                                <p class="text-muted mb-2">Response:</p>
                                                <p style="white-space: pre-wrap;">{{ interaction.response }}</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                {% set category_data = categories_data[category] %}
                {% if category_data['total_pages'] > 1 and category == current_category %}
                <div class="d-flex justify-content-between align-items-center mt-4">
                    <div>
                        Showing {{ category_data['interactions']|length }} of {{ category_data['total_count'] }} interactions
                    </div>
                    <ul class="pagination">
                        {% if page > 1 %}
                        <li class="page-item">
                            <a class="page-link" href="javascript:void(0)" onclick="changePage({{ page - 1 }})">
                                <i class="bi bi-chevron-left"></i> Previous
                            </a>
                        </li>
                        {% endif %}
                        
                        {% for p in range(1, category_data['total_pages'] + 1) %}
                        {% if p >= page - 2 and p <= page + 2 %}
                        <li class="page-item {{ 'active' if p == page else '' }}">
                            <a class="page-link" href="javascript:void(0)" onclick="changePage({{ p }})">
                                {{ p }}
                            </a>
                        </li>
                        {% endif %}
                        {% endfor %}
                        
                        {% if page < category_data['total_pages'] %}
                        <li class="page-item">
                            <a class="page-link" href="javascript:void(0)" onclick="changePage({{ page + 1 }})">
                                Next <i class="bi bi-chevron-right"></i>
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </div>
                {% elif category == current_category %}
                <div class="d-flex justify-content-between align-items-center mt-4">
                    <div>
                        Showing {{ category_data['interactions']|length }} of {{ category_data['total_count'] }} interactions
                    </div>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Initialize Bootstrap tabs
    document.addEventListener('DOMContentLoaded', function() {
        // Get current category from URL or default to 'term'
        const urlParams = new URLSearchParams(window.location.search)
        const currentCategory = urlParams.get('category') || 'term'
        
        // Set the correct active tab based on current category
        const tabTarget = currentCategory === 'news_suggestion' ? 'news' : currentCategory
        const activeTab = document.querySelector(`#interactionTabs button[data-bs-target="#${tabTarget}"]`)
        const activePane = document.querySelector(`#${tabTarget}`)
        
        // Remove all active classes first
        document.querySelectorAll('#interactionTabs .nav-link').forEach(tab => tab.classList.remove('active'))
        document.querySelectorAll('.tab-pane').forEach(pane => {
            pane.classList.remove('show', 'active')
        })
        
        // Set the correct tab and pane as active
        if (activeTab && activePane) {
            activeTab.classList.add('active')
            activePane.classList.add('show', 'active')
        }

        var triggerTabList = [].slice.call(document.querySelectorAll('#interactionTabs button'))
        triggerTabList.forEach(function(triggerEl) {
            var tabTrigger = new bootstrap.Tab(triggerEl)
            triggerEl.addEventListener('click', function(event) {
                event.preventDefault()
                tabTrigger.show()
                // Get full category name, handling 'news_suggestion' special case
                let category = this.getAttribute('data-bs-target').replace('#', '')
                if (category === 'news') {
                    category = 'news_suggestion'
                }
                loadSummary(category)
            })
        })

        // Load initial summary for the current category
        loadSummary(currentCategory)
    });

    async function loadSummary(category) {
        const summaryElement = document.getElementById(`${category}-summary`)
        
        if (!summaryElement) {
            console.warn(`Summary element not found for category: ${category}`)
            return
        }
        
        try {
            const response = await fetch(`/admin/interactions/summaries/${category}`)
            if (!response.ok) throw new Error('Network response was not ok')
            const data = await response.json()
            
            // Update the summary content
            if (data.summary) {
                summaryElement.innerHTML = `<div style="white-space: pre-wrap;">${data.summary}</div>`
            } else {
                summaryElement.innerHTML = '<div class="text-muted">No summary available for this category.</div>'
            }
        } catch (error) {
            console.error('Error loading summary:', error)
            summaryElement.innerHTML = '<div class="text-danger">Failed to load summary. Please try again later.</div>'
        }
    }



    // Handle form submission with current category
    document.getElementById('filterForm').addEventListener('submit', function(e) {
        e.preventDefault()
        applyFilters()
    })

    function applyFilters() {
        const currentCategory = getCurrentCategory()
        const search = document.getElementById('search').value
        const feedback = document.getElementById('feedback').value
        
        let url = `/admin/interactions?category=${currentCategory}`
        if (search) url += `&search=${encodeURIComponent(search)}`
        if (feedback) url += `&feedback=${encodeURIComponent(feedback)}`
        
        window.location.href = url
    }

    function clearFilters() {
        document.getElementById('search').value = ''
        document.getElementById('feedback').value = ''
        const currentCategory = getCurrentCategory()
        window.location.href = `/admin/interactions?category=${currentCategory}`
    }

    function changePage(page) {
        const currentCategory = getCurrentCategory()
        const search = document.getElementById('search').value
        const feedback = document.getElementById('feedback').value
        
        let url = `/admin/interactions?category=${currentCategory}&page=${page}`
        if (search) url += `&search=${encodeURIComponent(search)}`
        if (feedback) url += `&feedback=${encodeURIComponent(feedback)}`
        
        window.location.href = url
    }

    function getCurrentCategory() {
        const activeTab = document.querySelector('#interactionTabs .nav-link.active')
        if (!activeTab) return 'term'
        
        const target = activeTab.getAttribute('data-bs-target').replace('#', '')
        return target === 'news' ? 'news_suggestion' : target
    }

    // Handle tab switching with URL update
    document.querySelectorAll('#interactionTabs .nav-link').forEach(tab => {
        tab.addEventListener('click', function(e) {
            e.preventDefault()
            const category = this.getAttribute('data-bs-target').replace('#', '')
            const fullCategory = category === 'news' ? 'news_suggestion' : category
            
            // Update URL to maintain filters but change category
            const search = document.getElementById('search').value
            const feedback = document.getElementById('feedback').value
            
            let url = `/admin/interactions?category=${fullCategory}`
            if (search) url += `&search=${encodeURIComponent(search)}`
            if (feedback) url += `&feedback=${encodeURIComponent(feedback)}`
            
            window.location.href = url
        })
    })
</script>
{% endblock %}