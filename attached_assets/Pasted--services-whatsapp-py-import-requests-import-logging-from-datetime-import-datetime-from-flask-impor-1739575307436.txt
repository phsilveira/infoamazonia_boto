# services/whatsapp.py
import requests
import logging
from datetime import datetime
from flask import current_app
from app.models import Message
from app import db

logger = logging.getLogger(__name__)

def send_message_official(to: str, body: str) -> dict:
    """Send message using official WhatsApp Cloud API"""
    try:
        url = f"{current_app.config['WHATSAPP_API_URL']}{current_app.config['WHATSAPP_NUMBER_ID']}/messages"
        headers = {
            'Content-Type': 'application/json',
            'Authorization': f"Bearer {current_app.config['WHATSAPP_ACCESS_TOKEN']}"
        }
        payload = {
            "messaging_product": "whatsapp",
            "recipient_type": "individual",
            "to": to,
            "type": "text",
            "text": {
                "preview_url": False,
                "body": body
            }
        }

        logger.debug(f"Sending message to {to} via official API")
        response = requests.post(url, headers=headers, json=payload)
        response.raise_for_status()
        response_data = response.json()

        if 'messages' in response_data and len(response_data['messages']) > 0:
            whatsapp_message_id = response_data['messages'][0]['id']
            # Log the outgoing message
            message = Message(
                whatsapp_message_id=whatsapp_message_id,
                phone_number=to,
                message_type='outgoing',
                message_content=body,
                status='sent',
                status_timestamp=datetime.now()
            )
            db.session.add(message)
            db.session.commit()
            logger.info(f"Successfully logged outgoing message {whatsapp_message_id}")
            return {"status": "success", "message": "Message sent successfully via official API"}
        else:
            logger.error("No message ID in response")
            return {"status": "error", "message": "No message ID in response"}

    except Exception as e:
        logger.error(f"Error sending message via official API: {str(e)}")
        return {"status": "error", "message": str(e)}

def send_message_unofficial(to: str, body: str) -> dict:
    """Send message using unofficial API"""
    try:
        response = requests.post(
            current_app.config['EXTERNAL_SERVICE_URL'],
            json={
                "phone": to,
                "message": body,
            },
            headers={
                'Client-Token': "F2ca17ab243694b9b981973fec57895daS",
                'Content-Type': 'application/json'
            },
            timeout=5
        )
        response.raise_for_status()

        # Generate a unique message ID for unofficial API
        message_id = f"unofficial-{datetime.now().timestamp()}"

        # Log the outgoing message
        message = Message(
            whatsapp_message_id=message_id,
            phone_number=to,
            message_type='outgoing',
            message_content=body,
            status='sent',
            status_timestamp=datetime.now()
        )
        db.session.add(message)
        db.session.commit()
        logger.info(f"Successfully logged outgoing message {message_id}")

        return {"status": "success", "message": "Message sent successfully via unofficial API"}
    except Exception as e:
        logger.error(f"Error sending message via unofficial API: {str(e)}")
        return {"status": "error", "message": str(e)}

def send_message(to: str, body: str) -> dict:
    """Unified message sending function that delegates to appropriate implementation"""
    use_official_api = current_app.config.get('USE_OFFICIAL_API', False)
    if use_official_api:
        return send_message_official(to, body)
    return send_message_unofficial(to, body)