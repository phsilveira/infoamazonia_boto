# services/chatbot.py
from transitions import Machine
from app.models import User, Location, Subject
from app import db
import logging

logger = logging.getLogger(__name__)

class ChatBot:
    states = ['start', 'register', 'menu_state', 'get_user_location', 'get_user_subject', 'get_user_schedule', 'about']

    def __init__(self):
        self.machine = Machine(
            model=self,
            states=ChatBot.states,
            initial='start',
            auto_transitions=False
        )

        # Define transitions with proper triggers
        self.machine.add_transition(
            trigger='verify_user',
            source='start',
            dest='register',
            conditions=['is_new_user']
        )
        self.machine.add_transition(
            trigger='show_menu',
            source=['start', 'register'],
            dest='menu_state'
        )
        self.machine.add_transition(
            trigger='select_subscribe',
            source='menu_state',
            dest='get_user_location'
        )
        self.machine.add_transition(
            trigger='proceed_to_subjects',
            source='get_user_location',
            dest='get_user_subject'
        )
        self.machine.add_transition(
            trigger='proceed_to_schedule',
            source='get_user_subject',
            dest='get_user_schedule'
        )
        self.machine.add_transition(
            trigger='select_about',
            source='menu_state',
            dest='about'
        )
        self.machine.add_transition(
            trigger='end_conversation',
            source=['register', 'get_user_schedule', 'about'],
            dest='start'
        )

    def set_state(self, state):
        """Set the state explicitly"""
        if state in self.states:
            self.state = state
        else:
            self.state = 'start'

    def is_new_user(self, phone_number):
        """Check if a user with the given phone number exists"""
        try:
            user = User.query.filter_by(phone_number=phone_number).first()
            return user is None
        except Exception as e:
            logger.error(f"Error checking user: {e}")
            return True

    def register_user(self, phone_number, name):
        """Register a new user with the given phone number and name"""
        try:
            new_user = User(phone_number=phone_number, name=name)
            db.session.add(new_user)
            db.session.commit()
            return new_user
        except Exception as e:
            db.session.rollback()
            raise e

    def get_user(self, phone_number):
        """Get an existing user by phone number"""
        return User.query.filter_by(phone_number=phone_number).first()

    def save_location(self, user_id, location_name):
        """Save a new location for the user"""
        try:
            new_location = Location(location_name=location_name, user_id=user_id)
            db.session.add(new_location)
            db.session.commit()
            return new_location
        except Exception as e:
            db.session.rollback()
            raise e

    def save_subject(self, user_id, subject_name):
        """Save a new subject for the user"""
        try:
            new_subject = Subject(subject_name=subject_name, user_id=user_id)
            db.session.add(new_subject)
            db.session.commit()
            return new_subject
        except Exception as e:
            db.session.rollback()
            raise e

    def save_schedule(self, user_id, schedule):
        """Save the user's preferred schedule"""
        try:
            user = User.query.get(user_id)
            if user:
                user.schedule = schedule
                db.session.commit()
                return user
            raise Exception("User not found")
        except Exception as e:
            db.session.rollback()
            raise e