def verify_webhook(mode: str, token: str, challenge: str) -> Tuple[Any, int]:
    """Handle WhatsApp Cloud API webhook verification"""
    if mode == 'subscribe' and token == current_app.config['WEBHOOK_VERIFY_TOKEN']:
        logger.info("Webhook verified successfully!")
        return challenge, 200
    else:
        logger.warning("Webhook verification failed.")
        return 'Forbidden', 403

@main_bp.route('/webhook', methods=['GET', 'POST'])
def webhook():
    """Handle incoming webhook requests for both official and unofficial API formats"""
    if request.method == 'GET':
        mode = request.args.get('hub.mode')
        token = request.args.get('hub.verify_token')
        challenge = request.args.get('hub.challenge')
        return verify_webhook(mode, token, challenge)

    # Handle POST requests
    try:
        data = request.get_json()
        logger.debug(f"Received webhook data: {data}")
        if not data:
            return jsonify({"error": "No data provided"}), 400

        # Handle WhatsApp Cloud API format
        if data.get('object') == 'whatsapp_business_account':
            for entry in data['entry']:
                for change in entry.get('changes', []):
                    if change.get('field') == 'messages':
                        value = change['value']

                        # Handle message status updates
                        if 'statuses' in value:
                            for status in value['statuses']:
                                handle_message_status(status)

                        # Handle incoming messages
                        if 'messages' in value:
                            for message_data in value['messages']:
                                if message_data['type'] == 'text':
                                    process_incoming_message(message_data, message_data['from'])
        else:
            # Handle unofficial API format
            handle_unofficial_api_message(data)

        return jsonify({
            "status": "success",
            "message": "Webhook received and being processed"
        })

    except Exception as e:
        logger.error(f"Error in webhook endpoint: {str(e)}")
        return jsonify({"error": "Internal server error"}), 500