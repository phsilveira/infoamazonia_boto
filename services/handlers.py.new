import logging
from services.chatbot import ChatBot
from services.chatgpt import ChatGPTService
from utils.message_loader import message_loader
from typing import Tuple
from services.whatsapp import send_message
from database import get_db
from models import UserInteraction, Location, Subject, User, Message # Added
from datetime import datetime, timedelta
from config import settings

logger = logging.getLogger(__name__)

async def handle_start_state(chatbot: ChatBot, phone_number: str) -> str:
    """Handle the start state logic"""
    if chatbot.is_new_user(phone_number):
        chatbot.register_user(phone_number)    

    chatbot.show_menu()
    message = message_loader.get_message('menu.main')
    await send_message(phone_number, message, next(get_db()))
    return chatbot.state

async def handle_register_state(chatbot: ChatBot, phone_number: str, message: str) -> str:
    """Handle the register state logic"""
    try:
        chatbot.register_user(phone_number)
        chatbot.show_menu()
        menu_message = message_loader.get_message('menu.main')
        await send_message(phone_number, menu_message, next(get_db()))
        return chatbot.state
    except Exception as e:
        error_message = message_loader.get_message('error.registration_failed', error=str(e))
        await send_message(phone_number, error_message, next(get_db()))
        return chatbot.state

async def handle_menu_state(chatbot: ChatBot, phone_number: str, message: str) -> str:
    """Handle the menu state logic with more flexible input handling"""
    message = message.lower().strip()
    db = next(get_db())

    if message in ['1', 'subscribe', 'inscrever', 'notícias']:
        chatbot.select_subscribe()
        await send_message(phone_number, message_loader.get_message('location.request'), db)
    elif message in ['2', 'termo']:
        chatbot.select_term_info()
        await send_message(phone_number, message_loader.get_message('menu.term_info'), db)
    elif message in ['3', 'resumo', 'artigo']:
        chatbot.select_article_summary()
        await send_message(phone_number, message_loader.get_message('menu.article_summary'), db)
    elif message in ['4', 'sugestão', 'pauta']:
        chatbot.select_news_suggestion()
        await send_message(phone_number, message_loader.get_message('menu.news_suggestion'), db)
    elif message in ['6', 'about', 'sobre', 'info']:
        chatbot.select_about()
        await send_message(phone_number, message_loader.get_message('about.info'), db)
        await send_message(phone_number, message_loader.get_message('return_to_menu_from_subscription'), next(get_db()))
        chatbot.end_conversation()
        
    elif message in ['5', 'desinscrever', 'cancelar']:
        chatbot.select_unsubscribe()
        await send_message(phone_number, message_loader.get_message('unsubscribe.confirm'), db)
    else:
        await send_message(phone_number, message_loader.get_message('menu.invalid_option'), db)

    return chatbot.state
async def handle_location_state(chatbot: ChatBot, phone_number: str, message: str, chatgpt_service: ChatGPTService) -> str:
    """Handle the location state logic"""
    db = next(get_db())
    user = chatbot.get_user(phone_number)

    try:
        # Check for 'voltar' keyword to go back to main menu
        if message.lower().strip() == 'voltar':
            chatbot.show_menu()
            menu_message = message_loader.get_message('menu.main')
            await send_message(phone_number, menu_message, db)
            return chatbot.state

        db.query(Location).filter(
            Location.user_id == user.id,
            Location.created_at <= datetime.utcnow() - timedelta(hours=1)
        ).delete()
        db.flush()
            
        confirmation_response = chatgpt_service.parse_confirmation(message)
        if confirmation_response is not None:
            if confirmation_response:
                await send_message(phone_number, message_loader.get_message('location.add_more'), db)
                return "get_user_location"
            else:
                chatbot.proceed_to_subjects()
                await send_message(phone_number, message_loader.get_message('subject.request'), db)
                return "get_user_subject"

        from services.location import validate_locations, get_location_details
        validation_results = validate_locations(message)

        # Handle "all locations" case
        if len(validation_results) == 1 and validation_results[0][1] == "ALL_LOCATIONS":
            try:
                location = Location(
                    location_name="Todos Locais",
                    latitude=None,
                    longitude=None,
                    user_id=user.id
                )
                db.add(location)
                db.commit()
                await send_message(
                    phone_number, 
                    message_loader.get_message('location.saved_all'), 
                    db
                )
                await send_message(phone_number, message_loader.get_message('subject.request'), db)
                return "get_user_subject"
            except Exception as e:
                db.rollback()
                logger.error(f"Error saving 'All Locations': {str(e)}")
                await send_message(phone_number, message_loader.get_message('error.save_location', error=str(e)), db)
                return chatbot.state

        # Get details for valid locations
        valid_locations = [result[1] for result in validation_results if result[0]]
        if not valid_locations:
            invalid_locations = [result[1] for result in validation_results if not result[0]]
            await send_message(
                phone_number, 
                message_loader.get_message('location.invalid', message=", ".join(invalid_locations)), 
                db
            )
            return chatbot.state

        # Get details and save valid locations
        locations_details = await get_location_details(message)
        saved_locations = []

        try:
            for location_detail in locations_details:
                location = Location(
                    location_name=location_detail["corrected_name"],
                    latitude=location_detail["latitude"],
                    longitude=location_detail["longitude"],
                    user_id=user.id
                )
                db.add(location)
                saved_locations.append(location_detail["corrected_name"])

            db.commit()

            # Notify about saved locations
            if len(saved_locations) == 1:
                await send_message(
                    phone_number, 
                    message_loader.get_message('location.saved', location=saved_locations[0]), 
                    db
                )
            else:
                await send_message(
                    phone_number, 
                    message_loader.get_message('location.saved_multiple', locations=", ".join(saved_locations)), 
                    db
                )
        except Exception as e:
            db.rollback()
            logger.error(f"Error saving locations: {str(e)}")
            await send_message(phone_number, message_loader.get_message('error.save_location', error=str(e)), db)

    except Exception as e:
        logger.error(f"Error in handle_location_state: {str(e)}")
        await send_message(phone_number, message_loader.get_message('error.process_message', error=str(e)), db)

    return chatbot.state
